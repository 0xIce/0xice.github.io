---
title: å¼€å§‹ä½¿ç”¨ RxSwift
categories:
  - RxSwift
tags:
  - RxSwift
toc: true
author_profile: false
sidebar:
  nav: RxSwift-docs
---
> ä¿¡å·å³åºåˆ—

`RxSwift` é¡¹ç›®å°è¯•ä¸ [ReactiveX.io](http://reactivex.io/) é¡¹ç›®ä¿æŒä¸€è‡´ï¼Œä¸€èˆ¬çš„è·¨å¹³å°çš„æ–‡æ¡£å’ŒæŒ‡å¯¼åŒæ ·é€‚ç”¨äº `RxSwift`

## Basic

è§‚å¯Ÿè€…æ¨¡å¼(`Observable<Element>` sequence)å’Œæ™®é€šçš„ sequence çš„[ç­‰ä»·](MathBehindRx.md)æ˜¯ Rx ä¸­æœ€é‡è¦çš„æ¦‚å¿µã€‚

**æ¯ä¸ª `Observable` sequence å°±æ˜¯ä¸€ä¸ª sequenceã€‚`Observable` ç›¸å¯¹äº Swift çš„ `Sequence` çš„ä¼˜åŠ¿åœ¨äºå¯ä»¥å¼‚æ­¥åœ°æ¥æ”¶å…ƒç´ ã€‚è¿™æ˜¯ RxSwift çš„æ ¸å¿ƒï¼Œæ¥ä¸‹æ¥çš„æ–‡æ¡£éƒ½æ˜¯å¯¹è¿™ä¸ªæƒ³æ³•çš„æ‰©å±•ã€‚**

* `Observable`(`ObservableType`) ç­‰ä»·äº `Sequence`
* `ObservableType.subscribe` æ–¹æ³•ç­‰ä»·äº `Sequence.makeIterator`
* Observer (callback) éœ€è¦è¢«ä¼ é€’ç»™ `ObservableType.subscribe` æ–¹æ³•æ¥æ¥å—åºåˆ—å…ƒç´ è€Œä¸æ˜¯å¯¹è¿”å›çš„ `iterator` è°ƒç”¨ `next()` 

Sequences æ˜¯ä¸€ä¸ªç®€å•ç†Ÿæ‚‰çš„æ¦‚å¿µï¼Œ**å®¹æ˜“å¯è§†åŒ–**

äººç±»æ˜¯æ‹¥æœ‰åºå¤§è§†è§‰å¤§è„‘çš®å±‚çš„ç”Ÿç‰©ï¼Œå¯ä»¥å¾ˆå®¹æ˜“ç†è§£å¯è§†åŒ–ä¹‹åçš„æ¦‚å¿µ

æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨åºåˆ—æ›´é«˜çº§çš„æ“ä½œä¸Šæ¨¡æ‹Ÿæ¯ä¸ª Rx æ“ä½œç¬¦å†…éƒ¨çš„äº‹ä»¶çŠ¶æ€æœºçš„æ–¹å¼æ¥æå‡æˆ‘ä»¬çš„è®¤çŸ¥

å¦‚æœæˆ‘ä»¬åœ¨æ„å»ºå¼‚æ­¥çš„ç³»ç»Ÿä½†æ˜¯æ²¡æœ‰ä½¿ç”¨ Rxï¼Œå¾ˆå¯èƒ½æ„å‘³ç€æˆ‘ä»¬çš„ä»£ç æœ‰å¾ˆå¤šçš„çŠ¶æ€æœºå’Œæš‚æ€éœ€è¦å»æ¨¡æ‹Ÿï¼Œè€Œä¸æ˜¯ä»¥ä¸€ç§æŠ½è±¡çš„æ–¹å¼

åˆ—è¡¨å’Œåºåˆ—å¤§æ¦‚æ˜¯æ•°å­¦å®¶å’Œç¨‹åºå‘˜é¦–å…ˆè¦å­¦ä¹ çš„æ¦‚å¿µä¹‹ä¸€

ä¸‹é¢æ˜¯ä¸€ä¸ªæ•°å­—åºåˆ—ï¼š


```
--1--2--3--4--5--6--| // terminates normally
```

ä¸‹é¢æ˜¯ä¸€ä¸ªå­—ç¬¦åºåˆ—ï¼š

```
--a--b--a--a--a---d---X // terminates with error
```

æœ‰äº›åºåˆ—æ˜¯æœ‰é™çš„ï¼Œæœ‰äº›åºåˆ—æ˜¯æ— é™çš„ï¼Œæ¯”å¦‚æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶äº§ç”Ÿçš„åºåˆ—ï¼š

```
---tap-tap-------tap--->
```

è¿™äº›è¢«ç§°ä¸ºå¼¹ç å›¾ï¼Œæ›´å¤šçš„å¼¹ç å›¾åœ¨<http://rxmarbles.com>

ä¸‹é¢ä¸¾ä¾‹è¯´æ˜ Rx ä¸­ sequence çš„è¯­æ³•ï¼š

**next\* (error \| completed)?**

è¡¨è¾¾çš„ä¿¡æ¯å¦‚ä¸‹:

* **Sequences å¯ä»¥æœ‰ 0 ä¸ªæˆ–è€…å¤šä¸ªå…ƒç´ **
* **ä¸€ä¸ª `error` æˆ–è€… `completed` äº‹ä»¶è¢«æ¥æ”¶ä¹‹åï¼Œè¿™ä¸ªåºåˆ—å°±ä¸èƒ½äº§ç”Ÿå…¶ä»–çš„å…ƒç´ äº†**

Rx ä¸­ä½¿ç”¨æ¨é€æ¥å£(å›è°ƒ)æ¥æè¿°åºåˆ—

```swift
enum Event<Element>  {
    case next(Element)      // next element of a sequence
    case error(Swift.Error) // sequence failed with error
    case completed          // sequence terminated successfully
}

class Observable<Element> {
    func subscribe(_ observer: Observer<Element>) -> Disposable
}

protocol ObserverType {
    func on(_ event: Event<Element>)
}
```

**å½“ä¸€ä¸ªåºåˆ—å‘é€ `completed` æˆ– `error` äº‹ä»¶çš„æ—¶å€™ï¼Œè¿™ä¸ªåºåˆ—ç”¨æ¥è®¡ç®—å…ƒç´ å ç”¨çš„æ‰€æœ‰çš„å†…éƒ¨èµ„æºå°†è¢«é‡Šæ”¾**

**å¦‚æœè¦å–æ¶ˆåºåˆ—å…ƒç´ çš„äº§ç”Ÿå¹¶ä¸”ç«‹é©¬é‡Šæ”¾èµ„æºï¼Œå¯¹è¿”å›çš„è®¢é˜…è°ƒç”¨ `dispose` æ–¹æ³•**

å¦‚æœä¸€ä¸ªåºåˆ—ä¼šåœ¨æœ‰é™çš„æ—¶é—´å†…ç»“æŸï¼Œä¸è°ƒç”¨ `dispose` æˆ–è€… `disposed(by: disposeBag)` ä¸ä¼šé€ æˆæ°¸ä¹…çš„èµ„æºæ³„æ¼ã€‚ç„¶è€Œï¼Œè¿™äº›èµ„æºä¼šåœ¨åºåˆ—å®Œæˆä¹‹å‰ä¸€ç›´è¢«ä½¿ç”¨ï¼Œåºåˆ—å®Œæˆçš„æƒ…å†µåŒ…æ‹¬ç»“æŸäº†å…ƒç´ çš„äº§ç”Ÿæˆ–è€…è¿”å›äº†é”™è¯¯ã€‚

å¦‚æœä¸€ä¸ªåºåˆ—ä¸ä¼šè‡ªå·±ç»ˆæ­¢ï¼Œæ¯”å¦‚æŒ‰é’®çš„è¿ç»­ç‚¹å‡»ï¼Œèµ„æºä¼šä¸€ç›´è¢«å ç”¨ç›´åˆ° `dispose` è¢«æ‰‹åŠ¨è°ƒç”¨ï¼Œåœ¨ `disposeBag` ä¸­è¢«è‡ªåŠ¨è°ƒç”¨ï¼Œä½¿ç”¨äº† `takeUntil` æ“ä½œç¬¦ï¼Œæˆ–è€…å…¶å®ƒçš„æ–¹å¼ã€‚

ä½¿ç”¨ `DisposeBag` æˆ–è€… `takeUntil` æ“ä½œç¬¦æ¥ä¿è¯èµ„æºè¢«æ­£ç¡®æ¸…ç†æ˜¯é²æ£’æ€§æ¯”è¾ƒå¥½çš„ä¸€ç§æ–¹å¼ã€‚æˆ‘ä»¬æ¨èåœ¨ç”Ÿäº§ä¸­ä½¿ç”¨å®ƒä»¬ï¼Œå³ä½¿åºåˆ—ä¼šåœ¨æœ‰é™çš„æ—¶é—´å†…ç»“æŸ

å¦‚æœä½ å¥½å¥‡ä¸ºä»€ä¹ˆ `Swift.Error` ä¸æ˜¯èŒƒå‹ï¼Œä½ å¯ä»¥åœ¨[è¿™é‡Œ](DesignRationale.md#why-error-type-isnt-generic)æ‰¾åˆ°è§£é‡Š

## Dispose

è¿˜æœ‰å¦å¤–çš„æ–¹å¼å¯ä»¥ç»ˆæ­¢è¢«è®¢é˜…çš„åºåˆ—ã€‚å½“æˆ‘ä»¬ç»“æŸäº†ä¸€ä¸ªåºåˆ—æƒ³è¦é‡Šæ”¾ç”¨æ¥è®¡ç®—å’Œä¼ é€’å…ƒç´ æ‰€å ç”¨çš„èµ„æºæ—¶ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸ªè®¢é˜…è°ƒç”¨ `dispose`

ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ `interval` æ“ä½œç¬¦çš„ä¾‹å­ï¼š

```swift
let scheduler = SerialDispatchQueueScheduler(qos: .default)
let subscription = Observable<Int>.interval(.milliseconds(300), scheduler: scheduler)
    .subscribe { event in
        print(event)
    }

Thread.sleep(forTimeInterval: 2.0)

subscription.dispose()
```

This will print:

```
0
1
2
3
4
5
```

> é€šå¸¸æ¥è¯´ä½ ä¸éœ€è¦æ‰‹åŠ¨è°ƒç”¨ `dispose` æ–¹æ³•ï¼Œè¿™é‡Œä»…ä»…æ˜¯ä¸ºäº†è¯´æ˜

æ‰‹åŠ¨è°ƒç”¨ `dispose` é€šå¸¸æ¥è¯´å¯èƒ½ä¼šé€ æˆåçš„ä»£ç ï¼Œå¯ä»¥ç”¨æ›´å¥½çš„æ–¹å¼æ¥æ¸…ç†è®¢é˜…ï¼Œæ¯”å¦‚ `DisposeBag`ï¼Œ`takeUntil` æ“ä½œç¬¦ï¼Œæˆ–è€…å…¶å®ƒçš„æœºåˆ¶ã€‚

æ‰€ä»¥åœ¨ `dispose` æ–¹æ³•è°ƒç”¨ä¹‹åè¿˜æœ‰æœ‰ä¸œè¥¿æ‰“å°å—ï¼Ÿç­”æ¡ˆæ˜¯ï¼šçœ‹æƒ…å†µ

* å¦‚æœ `scheduler` æ˜¯ **serial scheduler** (å¦‚ï¼š``MainScheduler``) å¹¶ä¸” `dispose` æ–¹æ³•åœ¨**åŒä¸€ä¸ª serial scheduler** ä¸Šè°ƒç”¨ï¼Œç­”æ¡ˆå°±æ˜¯ **no**
* å¦åˆ™å°±æ˜¯ **yes**

ä½ å¯ä»¥åœ¨[è¿™é‡Œ](Schedulers.md)æ‰¾åˆ°æ›´å¤šå…³äº scheduler çš„ä¿¡æ¯

ç®€å•æ¥è¯´ä½ æœ‰ä¸¤ä¸ªå¹¶è¡Œçš„å¤„ç†è¿‡ç¨‹ï¼š

* ä¸€ä¸ªåœ¨äº§ç”Ÿå…ƒç´ 
* å¦ä¸€ä¸ªåœ¨æ¸…ç†è®¢é˜…

â€œåœ¨è°ƒç”¨ `dispose` ä¹‹åè¿˜å¯ä»¥æœ‰ä¸œè¥¿æ‰“å°å—ï¼Ÿâ€çš„é—®é¢˜åœ¨ä¸Šé¢æ‰€è¯´çš„ä¸¤ä¸ªå¤„ç†è¿‡ç¨‹è¿è¡Œåœ¨ä¸åŒçš„ schedulers ä¸Šçš„æ—¶å€™æ ¹æœ¬å°±è¯´ä¸é€šã€‚

çœ‹çœ‹å…¶å®ƒçš„ä¾‹å­æ¥éªŒè¯ä¸€ä¸‹(`observeOn` åœ¨[è¿™é‡Œ](Schedulers.md)æœ‰è§£é‡Š)

å‡è®¾æˆ‘ä»¬æœ‰å¦‚ä¸‹çš„ä»£ç ï¼š

```swift
let subscription = Observable<Int>.interval(.milliseconds(300), scheduler: scheduler)
            .observeOn(MainScheduler.instance)
            .subscribe { event in
                print(event)
            }

// ....

subscription.dispose() // called from main thread

```

**åœ¨ `dispose` è°ƒç”¨ä¹‹åï¼Œä¸ä¼šå†æœ‰ä¸œè¥¿æ‰“å°ã€‚è¿™æ˜¯å¯ä»¥ä¿è¯çš„**

å†çœ‹ä¸‹é¢çš„ä¾‹å­ï¼š

```swift
let subscription = Observable<Int>.interval(.milliseconds(300), scheduler: scheduler)
            .observeOn(serialScheduler)
            .subscribe { event in
                print(event)
            }

// ...

subscription.dispose() // executing on same `serialScheduler`

```

**åœ¨ `dispose` è°ƒç”¨ä¹‹åï¼Œä¸ä¼šå†æœ‰ä¸œè¥¿æ‰“å°ã€‚è¿™æ˜¯å¯ä»¥ä¿è¯çš„**

### Dispose Bags

Dispose bags ç»™äº† Rx ç±»ä¼¼äº ARC çš„è¡¨ç°

å½“ä¸€ä¸ª `DisposeBag` è¢«é‡Šæ”¾çš„æ—¶å€™ï¼Œå®ƒä¼šå¯¹æ·»åŠ è¿› `DisposeBag` ä¸­çš„æ¯ä¸€ä¸ª `disposable` å¯¹è±¡éƒ½è°ƒç”¨ä¸€æ¬¡ `dispose` æ–¹æ³•

`DisposeBag` æ²¡æœ‰ `dispose` æ–¹æ³•ï¼Œæ‰€ä»¥ä¸èƒ½æ‰‹åŠ¨è°ƒç”¨ dispose æ¥æ¸…ç†èµ„æºï¼Œå¦‚æœéœ€è¦ç«‹åˆ»æ¸…ç†èµ„æºï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„ bag æ¥æ›¿æ¢åŸæ¥çš„

```swift
  self.disposeBag = DisposeBag()
```

è¿™æ ·å¯ä»¥æ¸…ç†åŸæ¥çš„å¼•ç”¨å¹¶æ¸…ç†èµ„æº

å¦‚æœè¿˜æ˜¯æƒ³è¦æ‰‹åŠ¨åœ°æ˜¾å¼æ¸…ç†ï¼Œå¯ä»¥ä½¿ç”¨ `CompositeDisposable`ã€‚**å®ƒæœ‰æˆ‘ä»¬æœŸæœ›çš„å’Œ `dispose` ä¸€æ ·çš„è¡¨ç°ï¼Œä½†æ˜¯å®ç°çš„ä¸åŒæ˜¯ï¼Œå½“è°ƒç”¨ `dispose` æ–¹æ³•æ—¶ï¼Œå®ƒä¼šç«‹é©¬æ¸…ç†æ–°åŠ è¿›æ¥çš„ `disposable` å¯¹è±¡**

### Take until

è¿˜å¯ä»¥ä½¿ç”¨ `takeUntil` æ“ä½œç¬¦æ¥å®ç°åœ¨ `dealloc` çš„æ—¶å€™è‡ªåŠ¨æ¸…ç†è®¢é˜…

```swift
sequence
    .takeUntil(self.rx.deallocated)
    .subscribe {
        print($0)
    }
```

## Implicit `Observable` guarantees

è¿˜æœ‰ä¸€äº›å¦å¤–çš„ä¿è¯ï¼Œæ‰€æœ‰çš„åºåˆ— producers(`Observable`s)å¿…é¡»éµå®ˆ

å®ƒä»¬åœ¨å“ªä¸ªçº¿ç¨‹ç”Ÿæˆå…ƒç´ å¹¶ä¸é‡è¦ï¼Œä½†æ˜¯å¦‚æœå®ƒä»¬ç”Ÿæˆäº†ä¸€ä¸ªå…ƒç´ ç„¶åæŠŠç”Ÿæˆçš„å…ƒç´ å‘é€åˆ°è§‚å¯Ÿè€… `observer.on(.next(nextElement))`ï¼Œå®ƒä»¬ä¸èƒ½å†å‘é€ä¸‹ä¸€ä¸ªå…ƒç´ çŸ¥é“ `observer.on` æ–¹æ³•æ‰§è¡Œç»“æŸ

å¹¶ä¸”åœ¨ `.next` æ²¡æœ‰ç»“æŸçš„æ—¶å€™ Producers ä¸èƒ½å‘é€ç»ˆæ­¢äº‹ä»¶ `.completed` æˆ–è€… `.error`

ç®€è¨€ä¹‹ï¼Œè€ƒè™‘ä¸‹é¢çš„ä¾‹å­ï¼š

```swift
someObservable
  .subscribe { (e: Event<Element>) in
      print("Event processing started")
      // processing
      print("Event processing ended")
  }
```

æ‰“å°é¡ºåºä¸€å®šæ˜¯ï¼š

```
Event processing started
Event processing ended
Event processing started
Event processing ended
Event processing started
Event processing ended
```

ç»å¯¹ä¸ä¼šå‡ºç°ï¼š

```
Event processing started
Event processing started
Event processing ended
Event processing ended
```

## Creating your own `Observable` (aka observable sequence)

å…³äº `Observable` æœ‰ä¸€ä¸ªé‡è¦çš„äº‹æƒ…éœ€è¦ç†è§£

**å½“ä¸€ä¸ª observable è¢«åˆ›å»ºçš„æ—¶å€™ï¼Œå®ƒå¹¶æ²¡æœ‰æ‰§è¡Œä»»ä½•å·¥ä½œ**

> æ¯”å¦‚è¯´ä¸€ä¸ªç½‘ç»œè¯·æ±‚çš„ observable è¢«åˆ›å»ºï¼Œå®é™…å¹¶æ²¡æœ‰å‘å‡ºç½‘ç»œè¯·æ±‚ï¼Œè¢«è®¢é˜…ä¹‹åæ‰å‘èµ·è¯·æ±‚

 `Observable` å¯ä»¥é€šè¿‡å¾ˆå¤šç§æ–¹å¼ç”Ÿæˆå…ƒç´ ï¼Œæœ‰äº›ä¼šå¼•èµ·å‰¯ä½œç”¨ï¼Œæœ‰äº›ä¼šè¿›å…¥ç°æœ‰çš„è¿è¡Œè¿›ç¨‹ä¸­ï¼Œæ¯”å¦‚é¼ æ ‡çš„ç‚¹å‡»äº‹ä»¶ç­‰ã€‚

**ä½†æ˜¯ï¼Œå¦‚æœä½ åªæ˜¯è°ƒç”¨ä¸€ä¸ªæ–¹æ³•è¿”å›äº† `Observable`ï¼Œå¹¶æ²¡æœ‰æ‰§è¡Œåºåˆ—çš„ç”Ÿæˆå¹¶ä¸”ä¹Ÿæ²¡æœ‰å‰¯ä½œç”¨ã€‚`Observable` ä»…ä»…å®šä¹‰äº†åºåˆ—è¯¥å¦‚ä½•ç”Ÿæˆå’Œä»€ä¹ˆä½¿ç”¨ä»€ä¹ˆå‚æ•°ç”Ÿæˆã€‚åºåˆ—çš„å®é™…ç”Ÿæˆå‘ç”Ÿåœ¨ `subscribe` æ–¹æ³•è°ƒç”¨ä¹‹åã€‚**

çœ‹ä¸‹é¢çš„ä¾‹å­ï¼Œå‡è®¾ä½ æœ‰ä¸€ä¸ªç±»ä¼¼åŸå‹çš„æ–¹æ³•ï¼š

```swift
func searchWikipedia(searchTerm: String) -> Observable<Results> {}
```

```swift
let searchForMe = searchWikipedia("me")

// no requests are performed, no work is being done, no URL requests were fired

let cancel = searchForMe
  // sequence generation starts now, URL requests are fired
  .subscribe(onNext: { results in
      print(results)
  })

```

æœ‰å¾ˆå¤šæ–¹æ³•å¯ä»¥åˆ›å»ºè‡ªå®šä¹‰çš„ `Observable` åºåˆ—ï¼Œæœ€ç®€å•çš„æ–¹å¼å¤§æ¦‚å°±æ˜¯ä½¿ç”¨ `create` æ–¹æ³•

RxSwift æä¾›äº†ä¸€ä¸ªæ–¹æ³•æ¥åˆ›å»ºä¸€ä¸ªè¿”å›ä¸€ä¸ªå…ƒç´ ç»™è®¢é˜…è€…çš„åºåˆ—ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯ `just`ï¼Œä¸‹é¢æ˜¯æˆ‘ä»¬è‡ªå·±çš„å®ç°ã€‚

*å…·ä½“çš„å®ç°*

```swift
func myJust<E>(_ element: E) -> Observable<E> {
    return Observable.create { observer in
        observer.on(.next(element))
        observer.on(.completed)
        return Disposables.create()
    }
}

myJust(0)
    .subscribe(onNext: { n in
      print(n)
    })
```

ä¸Šé¢çš„ä»£ç å°†ä¼šæ‰“å°:

```
0
```

é‚£ä»€ä¹ˆæ˜¯ `create` æ–¹æ³•å‘¢ï¼Ÿ

å®ƒåªæ˜¯ä¸€ä¸ªå¯ä»¥è®©ä½ å®¹æ˜“ä½¿ç”¨ Swift çš„é—­åŒ…å®ç° `sbuscribe` æ–¹æ³•çš„ä¾¿åˆ©æ–¹æ³•ã€‚å°±åƒ `subscribe` æ–¹æ³•ä¸€æ ·ï¼Œ`create` æ–¹æ³•éœ€è¦ä¸€ä¸ªå‚æ•°ï¼Œ`observer`ï¼Œç„¶åè¿”å› `disposable` å¯¹è±¡

åºåˆ—çš„è¿™ç§å®ç°å®é™…ä¸Šæ˜¯åŒæ­¥çš„ï¼Œå®ƒå°†ä¼šç”Ÿæˆå…ƒç´ ç„¶ååœ¨ `subscribe` è°ƒç”¨è¿”å› `disposable` ä¹‹å‰ç»ˆæ­¢ã€‚å› æ­¤ï¼Œè¿”å›ä»€ä¹ˆ `disposable` å¹¶ä¸é‡è¦ï¼Œç”Ÿæˆå…ƒç´ çš„è¿‡ç¨‹ä¸ä¼šè¢«æ‰“æ–­ã€‚

å½“ç”ŸæˆåŒæ­¥åºåˆ—çš„æ—¶å€™ï¼Œé€šå¸¸è¿”å›çš„ `disposable` å¯¹è±¡æ˜¯ `NopDisposable` çš„å•ä¾‹ã€‚

æ¥çœ‹å¦ä¸€ä¸ªä¾‹å­ï¼Œåˆ›å»º `observable` è¿”å›ä¸€ä¸ªæ•°ç»„ä¸­çš„å…ƒç´ 

*å…·ä½“çš„å®ç°å¦‚ä¸‹*

```swift
func myFrom<E>(_ sequence: [E]) -> Observable<E> {
    return Observable.create { observer in
        for element in sequence {
            observer.on(.next(element))
        }

        observer.on(.completed)
        return Disposables.create()
    }
}

let stringCounter = myFrom(["first", "second"])

print("Started ----")

// first time
stringCounter
    .subscribe(onNext: { n in
        print(n)
    })

print("----")

// again
stringCounter
    .subscribe(onNext: { n in
        print(n)
    })

print("Ended ----")
```

è¾“å‡ºç»“æœæ˜¯ï¼š

```
Started ----
first
second
----
first
second
Ended ----
```

## Creating an `Observable` that performs work

å°è¯•ä¸€ä¸‹æ›´æœ‰æ„æ€çš„äº‹æƒ…ï¼Œåˆ›å»ºä¸€ä¸ªå‰é¢ç”¨åˆ°è¿‡çš„ `interval` æ“ä½œç¬¦

*ä¸‹é¢çš„å®ç°ç­‰ä»·äº dispatch queue schedulers*

```swift
func myInterval(_ interval: DispatchTimeInterval) -> Observable<Int> {
    return Observable.create { observer in
        print("Subscribed")
        let timer = DispatchSource.makeTimerSource(queue: DispatchQueue.global())
        timer.schedule(deadline: DispatchTime.now() + interval, repeating: interval)

        let cancel = Disposables.create {
            print("Disposed")
            timer.cancel()
        }

        var next = 0
        timer.setEventHandler {
            if cancel.isDisposed {
                return
            }
            observer.on(.next(next))
            next += 1
        }
        timer.resume()

        return cancel
    }
}
```

```swift
let counter = myInterval(.milliseconds(100))

print("Started ----")

let subscription = counter
    .subscribe(onNext: { n in
        print(n)
    })


Thread.sleep(forTimeInterval: 0.5)

subscription.dispose()

print("Ended ----")
```

è¾“å‡ºç»“æœæ˜¯
```
Started ----
Subscribed
0
1
2
3
4
Disposed
Ended ----
```

å¦‚æœå†™æˆä¸‹é¢è¿™æ ·

```swift
let counter = myInterval(.milliseconds(100))

print("Started ----")

let subscription1 = counter
    .subscribe(onNext: { n in
        print("First \(n)")
    })
let subscription2 = counter
    .subscribe(onNext: { n in
        print("Second \(n)")
    })

Thread.sleep(forTimeInterval: 0.5)

subscription1.dispose()

Thread.sleep(forTimeInterval: 0.5)

subscription2.dispose()

print("Ended ----")
```

è¾“å‡ºç»“æœæ˜¯

```
Started ----
Subscribed
Subscribed
First 0
Second 0
First 1
Second 1
First 2
Second 2
First 3
Second 3
First 4
Second 4
Disposed
Second 5
Second 6
Second 7
Second 8
Second 9
Disposed
Ended ----
```

**æ¯ä¸ªå¯¹ `subscription` çš„è®¢é˜…è€…é€šå¸¸ç”Ÿæˆè‡ªå·±ç‹¬ç«‹çš„å…ƒç´ åºåˆ—ã€‚æ“ä½œç¬¦é»˜è®¤æ˜¯æ— çŠ¶æ€çš„ã€‚æ— çŠ¶æ€çš„æ“ä½œç¬¦è¿œè¿œå¤šä½™æœ‰çŠ¶æ€çš„**

## Sharing subscription and `share` operator

å¦‚æœæˆ‘ä»¬å¸Œæœ›å¤šä¸ª observer é€šè¿‡åŒä¸€ä¸ªè®¢é˜…å…±äº«äº‹ä»¶(å…ƒç´ )å‘¢ï¼Ÿ

æœ‰ä¸¤ä¸ªäº‹æƒ…éœ€è¦å®šä¹‰ï¼š

* å¦‚ä½•å»å¤„ç†åœ¨æ–°çš„è®¢é˜…è€…è®¢é˜…ä¹‹å‰å·²ç»è¢«ä¼ é€’è¿‡çš„å…ƒç´ ï¼ˆé‡ä¼ æœ€åä¸€ä¸ªï¼Œé‡ä¼ æ‰€æœ‰ï¼Œé‡ä¼ æœ€åçš„ n ä¸ªï¼‰
* å¦‚ä½•å†³å®šä»€ä¹ˆæ—¶å€™è§¦å‘å…±äº«çš„è®¢é˜…ï¼ˆå¼•ç”¨æ•°ï¼Œæ‰‹åŠ¨è§¦å‘ï¼Œå…¶å®ƒçš„ç®—æ³•ï¼‰

é€šå¸¸çš„é€‰æ‹©æ˜¯  `replay(1).refCount()` çš„ç»„åˆï¼Œä¹Ÿå°±æ˜¯ `share(replay: 1)`

```swift
let counter = myInterval(.milliseconds(100))
    .share(replay: 1)

print("Started ----")

let subscription1 = counter
    .subscribe(onNext: { n in
        print("First \(n)")
    })
let subscription2 = counter
    .subscribe(onNext: { n in
        print("Second \(n)")
    })

Thread.sleep(forTimeInterval: 0.5)

subscription1.dispose()

Thread.sleep(forTimeInterval: 0.5)

subscription2.dispose()

print("Ended ----")
```

This will print

```
Started ----
Subscribed
First 0
Second 0
First 1
Second 1
First 2
Second 2
First 3
Second 3
First 4
Second 4
# First 5ï¼Œåº”è¯¥æ²¡æœ‰è¿™è¡Œè¾“å‡ºï¼ŒåŸæ–‡æ¡£é”™è¯¯
Second 5
Second 6
Second 7
Second 8
Second 9
Disposed
Ended ----
```

> ç°åœ¨åªæœ‰ä¸€ä¸ª `Subscribed` å’Œ `Disposed` äº‹ä»¶

URL observables çš„è¡¨ç°ä¹Ÿæ˜¯ç­‰ä»·çš„

ä¸‹é¢æ˜¯ç”¨ Rx å¯¹ HTTP è¯·æ±‚çš„å°è£…ï¼Œå’Œ `interval` çš„æ¨¡å¼éå¸¸ç›¸è¿‘

```swift
extension Reactive where Base: URLSession {
    public func response(request: URLRequest) -> Observable<(response: HTTPURLResponse, data: Data)> {
        return Observable.create { observer in
            let task = self.base.dataTask(with: request) { (data, response, error) in

                guard let response = response, let data = data else {
                    observer.on(.error(error ?? RxCocoaURLError.unknown))
                    return
                }

                guard let httpResponse = response as? HTTPURLResponse else {
                    observer.on(.error(RxCocoaURLError.nonHTTPResponse(response: response)))
                    return
                }

                observer.on(.next((httpResponse, data)))
                observer.on(.completed)
            }

            task.resume()

            return Disposables.create {
                task.cancel()
            }
        }
    }
}
```

## Operators

RxSwift å®ç°äº†å¾ˆå¤šæ“ä½œç¬¦

æ‰€æœ‰æ“ä½œç¬¦çš„å¼¹ç å›¾å¯ä»¥æŸ¥çœ‹<http://reactivex.io/>

å‡ ä¹æ‰€æœ‰çš„æ“ä½œç¬¦éƒ½åœ¨ [Playgrounds](#Playgrounds) ä¸­æœ‰æ¼”ç¤º

å¦‚æœä½ éœ€è¦ä¸€ä¸ªæ“ä½œç¬¦ä½†æ˜¯åˆä¸çŸ¥é“æ€ä¹ˆæ‰¾åˆ°å®ƒï¼Œå¯ä»¥æŸ¥çœ‹[æ“ä½œç¬¦å†³ç­–æ ‘](http://reactivex.io/documentation/operators.html#tree)

### Custom operator

æœ‰ä¸¤ç§æ–¹å¼å¯ä»¥å¯ä»¥åˆ›å»ºè‡ªå®šä¹‰çš„æ“ä½œç¬¦

#### Easy way

å†…éƒ¨çš„ä»£ç éƒ½æ˜¯ç”¨äº†é«˜åº¦ä¼˜åŒ–ç‰ˆæœ¬çš„æ“ä½œç¬¦ï¼Œæ‰€ä»¥ä»–ä»¬ä¸æ˜¯æœ€å¥½çš„è¾…å¯¼ææ–™ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆé¼“åŠ±ä½¿ç”¨æ ‡å‡†æ“ä½œç¬¦çš„åŸå› 

å¹¸è¿çš„æœ‰ä¸€ç§ç®€å•çš„æ–¹å¼å»åˆ›å»ºæ“ä½œç¬¦ã€‚åˆ›å»ºæ–°çš„æ“ä½œç¬¦å®é™…ä¸Šå°±æ˜¯åˆ›å»º `observable`ï¼Œå¹¶ä¸”å‰é¢çš„ç« èŠ‚å·²ç»æè¿°äº†æ€ä¹ˆåš

ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•å®ç°ä¸€ä¸ªæœªä¼˜åŒ–è¿‡çš„ `map` æ“ä½œç¬¦

```swift
extension ObservableType {
    func myMap<R>(transform: @escaping (E) -> R) -> Observable<R> {
        return Observable.create { observer in
            let subscription = self.subscribe { e in
                    switch e {
                    case .next(let value):
                        let result = transform(value)
                        observer.on(.next(result))
                    case .error(let error):
                        observer.on(.error(error))
                    case .completed:
                        observer.on(.completed)
                    }
                }

            return subscription
        }
    }
}
```

è°ƒç”¨æˆ‘ä»¬è‡ªå®šä¹‰çš„ `map`:

```swift
let subscription = myInterval(.milliseconds(100))
    .myMap { e in
        return "This is simply \(e)"
    }
    .subscribe(onNext: { n in
        print(n)
    })
```

è¾“å‡ºçš„ç»“æœï¼š

```
Subscribed
This is simply 0
This is simply 1
This is simply 2
This is simply 3
This is simply 4
This is simply 5
This is simply 6
This is simply 7
This is simply 8
...
```

#### Life happens

å¦‚æœåœ¨æŸäº›æƒ…å†µä¸‹ç”¨è‡ªå®šä¹‰çš„æ“ä½œç¬¦éš¾ä»¥è§£å†³é—®é¢˜å‘¢ï¼Ÿä½ å¯ä»¥è·³å‡º Rx çš„å•ä¸€ä¸–ç•Œï¼Œç”¨å‘½ä»¤å¼ç¼–ç¨‹çš„æ–¹å¼æ‰§è¡Œä»»åŠ¡ï¼Œç„¶åä½¿ç”¨ `Subject` å†å°†ç»“æœå†ä¼ é€’ç»™ Rx

è¿™ä¸æ˜¯ä¸€ä»¶å¯ä»¥ç»å¸¸åšçš„äº‹æƒ…ï¼Œå¯èƒ½ä¼šå¯¼è‡´ä¸è‰¯ä»£ç ï¼Œä½†æ˜¯è¿˜æ˜¯å¯ä»¥å®ç°çš„ã€‚

```swift
  let magicBeings: Observable<MagicBeing> = summonFromMiddleEarth()

  magicBeings
    .subscribe(onNext: { being in     // exit the Rx monad
        self.doSomeStateMagic(being)
    })
    .disposed(by: disposeBag)

  //
  //  Mess
  //
  let kitten = globalParty(   // calculate something in messy world
    being,
    UIApplication.delegate.dataSomething.attendees
  )
  kittens.on(.next(kitten))   // send result back to rx
  //
  // Another mess
  //

  let kittens = BehaviorRelay(value: firstKitten) // again back in Rx monad

  kittens.asObservable()
    .map { kitten in
      return kitten.purr()
    }
    // ....
```

å½“ä½ è¿™ä¹ˆåšçš„æ—¶å€™ï¼Œå…¶ä»–äººå¯èƒ½ä¼šåœ¨å…¶å®ƒåœ°æ–¹äº›è¿™æ ·çš„ä»£ç ğŸ‘‡

```swift
  kittens
    .subscribe(onNext: { kitten in
      // do something with kitten
    })
    .disposed(by: disposeBag)
```

æ‰€ä»¥å°½é‡ä¸è¦è¿™æ ·åš

## Playgrounds

å¦‚æœä½ ä¸ç¡®å®šæŸäº›æ“ä½œç¬¦å¦‚ä½•å·¥ä½œï¼Œ[playgrounds](https://github.com/ReactiveX/RxSwift/tree/master/Rx.playground) å‡ ä¹åŒ…æ‹¬äº†æ‰€æœ‰çš„æ“ä½œç¬¦ï¼Œå¹¶ä¸”å‡†å¤‡äº†å°ä¾‹å­æ¥æè¿°ä»–ä»¬çš„è¡¨ç°

ä½¿ç”¨ playgrounds:

1. æ‰“å¼€ Rx.xcworkspace
2. build RxSwift çš„ macOS scheme
3. æ‰“å¼€ Rx.playground

æŸ¥çœ‹ playgrounds ä¸­ä¾‹å­çš„ç»“æœï¼Œéœ€è¦æ‰“å¼€ `Assistant Editor`ï¼Œ`View > Assistant Editor > Show Assistant Editor`

## Error handling

æœ‰ä¸¤ç§é”™è¯¯å¤„ç†æœºåˆ¶

### Asynchronous error handling mechanism in observables

é”™è¯¯å¤„ç†éå¸¸ç›´æ¥ï¼Œå¦‚æœä¸€ä¸ªåºåˆ—å› ä¸ºé”™è¯¯ç»ˆæ­¢ï¼Œé‚£ä¹ˆæ‰€æœ‰ä¾èµ–çš„åºåˆ—éƒ½ä¼šå› ä¸ºé”™è¯¯ç»ˆæ­¢ï¼Œç¬¦åˆé€šå¸¸çš„çŸ­è·¯é€»è¾‘

ä½ å¯ä»¥ä½¿ç”¨ `catch` æ“ä½œç¬¦æ¥æ¢å¤ `observable` çš„å¤±è´¥ï¼Œ`catch` æ“ä½œç¬¦ä¸­è¿˜åœ¨åŸºæœ¬çš„ `error` ä¿¡æ¯åŸºç¡€ä¸Šæœ‰å„ç§å„æ ·çš„è¡¥å……ä¿¡æ¯ï¼Œå¯ä»¥è®©ä½ ä»¥æ›´ç»†èŠ‚çš„æ–¹å¼æ¢å¤åºåˆ—

è¿˜å¯ä»¥ä½¿ç”¨ `retry` æ“ä½œç¬¦æ¥é‡è¯•é”™è¯¯çš„åºåˆ—

## Debugging Compile Errors

å½“ç¼–å†™ä¼˜é›…çš„ `RxSwift/RxCocoa` ä»£ç çš„æ—¶å€™ï¼Œä½ å¯èƒ½å¼ºçƒˆä¾èµ–äºç¼–è¯‘å™¨æ¥æ¨æ–­ `Observable` çš„ç±»å‹ï¼Œè¿™æ˜¯ Swift ä¼˜ç§€çš„åŸå› ï¼Œä½†æ˜¯æœ‰æ—¶å€™ä¹Ÿä¼šä»¤äººæ³„æ°”

```swift
images = word
    .filter { $0.containsString("important") }
    .flatMap { word in
        return self.api.loadFlickrFeed("karate")
            .catchError { error in
                return just(JSON(1))
            }
      }
```

å¦‚æœç¼–è¯‘å™¨æŠ¥å‘Šäº†é”™è¯¯ï¼Œå¯ä»¥å…ˆå¢åŠ  `catch` çš„è¿”å›å€¼å£°æ˜

```swift
images = word
    .filter { s -> Bool in s.containsString("important") }
    .flatMap { word -> Observable<JSON> in
        return self.api.loadFlickrFeed("karate")
            .catchError { error -> Observable<JSON> in
                return just(JSON(1))
            }
      }
```

å¦‚æœä¸æˆåŠŸï¼Œå¯ä»¥ç»§ç»­æ·»åŠ æ›´å¤šçš„ç±»å‹å£°æ˜ç›´åˆ°å®šä½åˆ°äº†é”™è¯¯

```swift
images = word
    .filter { (s: String) -> Bool in s.containsString("important") }
    .flatMap { (word: String) -> Observable<JSON> in
        return self.api.loadFlickrFeed("karate")
            .catchError { (error: Error) -> Observable<JSON> in
                return just(JSON(1))
            }
      }
```

**å»ºè®®é¦–å…ˆå¢åŠ é—­åŒ…çš„è¿”å›å€¼å’Œå‚æ•°çš„å£°æ˜**

é€šå¸¸åœ¨ä½ è§£å†³äº†é”™è¯¯ä¹‹åï¼Œä½ å°±å¯ä»¥åˆ é™¤æ·»åŠ çš„å£°æ˜ä»¥ä¿æŒä»£ç çš„æ•´æ´

## Debugging

åªä½¿ç”¨è°ƒè¯•å™¨æ˜¯æœ‰ç”¨çš„ï¼Œä½†æ˜¯é€šå¸¸ä½¿ç”¨ `debug` æ“ä½œç¬¦å°†ä¼šæ›´åŠ çš„æœ‰æ•ˆç‡ã€‚`debug` æ“ä½œç¬¦ä¼šæ‰“å°æ‰€æœ‰çš„äº‹ä»¶åˆ°æ ‡å‡†è¾“å‡ºå¹¶ä¸”ä½ å¯ä»¥æ·»åŠ è‡ªå®šä¹‰çš„æ ‡ç­¾

`debug` çš„è¡¨ç°ç±»ä¼¼äºæ¢é’ˆï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ä¾‹å­ï¼š

```swift
let subscription = myInterval(.milliseconds(100))
    .debug("my probe")
    .map { e in
        return "This is simply \(e)"
    }
    .subscribe(onNext: { n in
        print(n)
    })

Thread.sleepForTimeInterval(0.5)

subscription.dispose()
```

will print

```
[my probe] subscribed
Subscribed
[my probe] -> Event next(Box(0))
This is simply 0
[my probe] -> Event next(Box(1))
This is simply 1
[my probe] -> Event next(Box(2))
This is simply 2
[my probe] -> Event next(Box(3))
This is simply 3
[my probe] -> Event next(Box(4))
This is simply 4
[my probe] dispose
Disposed
```

åˆ›å»ºè‡ªå®šä¹‰ç‰ˆæœ¬çš„ `debug` æ“ä½œç¬¦ä¹Ÿæ¯”è¾ƒç®€å•

```swift
extension ObservableType {
    public func myDebug(identifier: String) -> Observable<Self.E> {
        return Observable.create { observer in
            print("subscribed \(identifier)")
            let subscription = self.subscribe { e in
                print("event \(identifier)  \(e)")
                switch e {
                case .next(let value):
                    observer.on(.next(value))

                case .error(let error):
                    observer.on(.error(error))

                case .completed:
                    observer.on(.completed)
                }
            }
            return Disposables.create {
                   print("disposing \(identifier)")
                   subscription.dispose()
            }
        }
    }
 }
```

### Enabling Debug Mode

ä¸ºäº†å¯ä»¥ [Debug memory leaks using `RxSwift.Resources`](#debugging-memory-leaks) æˆ–è€… [Log all HTTP requests automatically](#logging-http-traffic)ï¼Œä½ å¿…é¡»å¼€å¯ Debug æ¨¡å¼

ä¸ºäº†å¼€å¯ debug æ¨¡å¼ï¼Œä¸€ä¸ª `TRACE_RESOURCES` æ ‡å¿—å¿…é¡»åŠ åˆ° RxSwift target çš„ build settings ä¸­ï¼Œåœ¨ Other Swift Flags é€‰é¡¹ä¸‹

å¯¹äºå¦‚ä½•åœ¨ Cocoapods å’Œ Carthage ä¸­æ·»åŠ  `TRACE_RESOURCES` æ ‡å¿—çš„è¿›ä¸€æ­¥çš„è®¨è®ºå’Œä»‹ç»ï¼ŒæŸ¥çœ‹ [#378](https://github.com/ReactiveX/RxSwift/issues/378)

## Debugging memory leaks

åœ¨ debug æ¨¡å¼ä¸‹ï¼ŒRx ç”¨ `Resources.total` è¿½è¸ªæ‰€æœ‰åˆ†é…çš„èµ„æº

å¦‚æœä½ æƒ³æ·»åŠ ä¸€äº›èµ„æºæ³„æ¼çš„æ£€æµ‹é€»è¾‘ï¼Œæœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯å‘¨æœŸè¾“å‡º `RxSwift.Resources.total`

```swift
    /* add somewhere in
    func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplicationLaunchOptionsKey : Any]? = nil)
    */
    _ = Observable<Int>.interval(.seconds(1), scheduler: MainScheduler.instance)
        .subscribe(onNext: { _ in
            print("Resource count \(RxSwift.Resources.total)")
        })
```

æµ‹è¯•å†…å­˜æ³„æ¼æœ€æœ‰æ•ˆç‡çš„æ–¹å¼æ˜¯ï¼š

* æ‰“å¼€ä½ çš„é¡µé¢å¹¶ä½¿ç”¨
* å…³é—­ä½ çš„é¡µé¢
* è§‚å¯Ÿåˆå§‹çš„èµ„æºæ•°é‡
* å†æ¬¡æ‰“å¼€ä½ çš„é¡µé¢å¹¶ä½¿ç”¨
* å…³é—­ä½ çš„é¡µé¢
* è§‚å¯Ÿæœ€ç»ˆçš„èµ„æºæ•°é‡

å¦‚æœå¼€å§‹çš„èµ„æºæ•°é‡å’Œæœ€ç»ˆçš„èµ„æºæ•°é‡ä¸åŒï¼Œé‚£ä¹ˆå°±æœ‰å¯èƒ½å‡ºç°äº†å†…å­˜æ³„æ¼

ä¸¤æ¬¡æ‰“å¼€é¡µé¢çš„åŸå› æ˜¯ç¬¬ä¸€æ¬¡æ‰“å¼€å¼ºåˆ¶åŠ è½½äº† `lazy` çš„èµ„æº

## KVO

KVO æ˜¯ä¸€ç§ Objective-C çš„æœºåˆ¶ï¼Œæ„å‘³ç€å®ƒä¸æ˜¯ä¼´éšç€ç±»å‹å®‰å…¨æ¥æ„å»ºçš„ï¼ŒRx ä¹Ÿåœ¨å°è¯•è§£å†³ä¸€äº›è¿™æ ·çš„é—®é¢˜

Rx æœ‰ä¸¤ç§å†…å»ºçš„æ”¯æŒ KVO çš„æ–¹å¼

```swift
// KVO
extension Reactive where Base: NSObject {
    public func observe<E>(type: E.Type, _ keyPath: String, options: KeyValueObservingOptions, retainSelf: Bool = true) -> Observable<E?> {}
}

#if !DISABLE_SWIZZLING
// KVO
extension Reactive where Base: NSObject {
    public func observeWeakly<E>(type: E.Type, _ keyPath: String, options: KeyValueObservingOptions) -> Observable<E?> {}
}
#endif
```

ä¸€ä¸ªè§‚å¯Ÿ `UIView` çš„ frame çš„ä¾‹å­

**è­¦å‘Šï¼šUIKit ä¸æœä» KVOï¼Œ ä½†å®ƒå¯ä»¥å·¥ä½œ**

```swift
view
  .rx.observe(CGRect.self, "frame")
  .subscribe(onNext: { frame in
    ...
  })
```

or

```swift
view
  .rx.observeWeakly(CGRect.self, "frame")
  .subscribe(onNext: { frame in
    ...
  })
```

### `rx.observe`

`rx.observe` æ›´é«˜æ•ˆï¼Œå› ä¸ºå®ƒè¿™æ˜¯å¯¹ KVO æœºåˆ¶çš„ä¸€ä¸ªç®€å•å°è£…ï¼Œä½†æ˜¯ä½¿ç”¨åœºæ™¯ä¹Ÿæ›´åŠ å±€é™

* å¯ä»¥ç”¨åœ¨è§‚å¯Ÿ `self` å¼€å§‹çš„æˆ–è€…æ‰€æœ‰æƒå›¾(`retainSelf = false`) çš„ç¥–å…ˆ(æŒæœ‰å…³ç³»)å¼€å§‹çš„ path
* å¯ä»¥ç”¨åœ¨è§‚å¯Ÿæ‰€æœ‰æƒå›¾(`retainSelf = false`)çš„åä»£(æŒæœ‰å…³ç³»)å¼€å§‹çš„ path
* path åªèƒ½åŒ…å« `strong` ä¿®é¥°çš„å±æ€§ï¼Œå¦åˆ™å¯èƒ½ä¼šæœ‰å› ä¸ºåœ¨ dealloc ä¹‹å‰æ²¡æœ‰å–æ¶ˆæ³¨å†Œ KVO è€Œå¯¼è‡´ crash

E.g.

```swift
self.rx.observe(CGRect.self, "view.frame", retainSelf: false)
```

### `rx.observeWeakly`

`rx.observeWeakly` æœ‰æ—¶ç›¸å¯¹äº `rx.observe` ä¼šæœ‰ä¸€ç‚¹æ…¢ï¼Œå› ä¸ºåœ¨å¼±å¼•ç”¨çš„æ—¶å€™éœ€è¦å¤„ç†å¯¹è±¡çš„é‡Šæ”¾

`rx.observe` é€‚ç”¨çš„åœºæ™¯ `rx.observeWeakly` éƒ½å¯ä»¥ç”¨ï¼Œå¦å¤–è¿˜å¯ä»¥ç”¨åœ¨

* å› ä¸ºå®ƒä¸ä¼š retain è§‚å¯Ÿçš„å¯¹è±¡ï¼Œå®ƒå¯ä»¥ç”¨åœ¨ä»»ä½•æŒæœ‰å…³ç³»ä¸æ˜ç¡®çš„å¯¹è±¡ä¸Š
* å¯ä»¥ç”¨æ¥è§‚å¯Ÿ `weak` å±æ€§

E.g.

```swift
someSuspiciousViewController.rx.observeWeakly(Bool.self, "behavingOk")
```

### Observing structs

KVO æ˜¯ä¸€ä¸ª OC çš„æœºåˆ¶ï¼Œæ‰€ä»¥å®ƒä¸¥é‡ä¾èµ–äº `NSValue`

**RxCocoa å†…å»ºäº† KVO è§‚å¯Ÿ `CGRect`, `CGSize` å’Œ `CGPoint` ç»“æ„ä½“çš„æ”¯æŒ**

å½“è§‚å¯Ÿå…¶å®ƒç»“æ„ä½“çš„æ—¶å€™ï¼Œéœ€è¦æ‰‹åŠ¨ä» `NSValue` æå–å‡ºè¿™äº›ç»“æ„ä½“

[è¿™é‡Œ](../RxCocoa/Foundation/KVORepresentable+CoreGraphics.swift)æ˜¯ä¸€äº›ä¾‹å­ï¼Œæè¿°äº†å¦‚ä½•é€šè¿‡å®ç°  `KVORepresentable`  åè®®æ¥å¯¹å…¶å®ƒç»“æ„ä½“æå– KVO è§‚å¯Ÿæœºåˆ¶å’Œ  `rx.observe*` æ–¹æ³•

## UI layer tips

å½“ç»‘å®šåˆ° UIKit çš„ control ä¸Šæ—¶ï¼Œä½ çš„ `Observable` å¿…é¡»è¦æ»¡è¶³ UI å±‚çš„ä¸€äº›æ¡ä»¶

### Threading

`Observable` éœ€è¦åœ¨  `MainScheduler`(UIThread) å‘é€å€¼ï¼Œè¿™æ˜¯ UIKit/Cocoa çš„è¦æ±‚

è®©ä½ çš„ API åœ¨  `MainScheduler` è¿”å›ç»“æœé€šå¸¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚å¦‚æœä½ å°è¯•åœ¨åå°çº¿ç¨‹ç»‘å®šä¸€äº›ä¸œè¥¿åˆ° UI ä¸Šæ—¶ï¼Œåœ¨ Debug çš„ build æ¨¡å¼ä¸‹ï¼ŒRxCocoa é€šå¸¸ä¼šæŠ¥é”™ä¸€ä¸ªé”™è¯¯æ¥æç¤ºä½ 

ä½ éœ€è¦æ·»åŠ  `observeOn(MainScheduler.instance)` æ¥è§£å†³è¿™ä¸ªé—®é¢˜

**URLSession extension é»˜è®¤ä¸åœ¨ `MainScheduler` è¿”å›ç»“æœ**

### Errors

ä½ ä¸èƒ½ç»‘å®šå¤±è´¥åˆ° UIKit control ä¸Šï¼Œå› ä¸ºé‚£æ˜¯æœªå®šä¹‰çš„è¡¨ç°

å¦‚æœä½ ä¸çŸ¥é“ `Observable` æ˜¯å¦ä¼šå¤±è´¥ï¼Œä½ å¯ä»¥ä½¿ç”¨ `catchErrorJustReturn(valueThatIsReturnedWhenErrorHappens)` æ¥ä¿è¯å®ƒä¸ä¼šå¤±è´¥ï¼Œ**ä½†æ˜¯å½“é”™è¯¯å‘ç”Ÿä¹‹åï¼Œå®ƒçš„åºåˆ—ä»ä¼šå®Œæˆ**

å¦‚æœå¸Œæœ›åºåˆ—ç»§ç»­ç”Ÿäº§å…ƒç´ ï¼Œå°±éœ€è¦ä¸€äº›ç‰ˆæœ¬çš„ `retry`æ“ä½œç¬¦

### Sharing subscription

ä½ é€šå¸¸å¸Œæœ›åœ¨ UI å±‚å…±äº«è®¢é˜…ï¼Œä½ ä¸å¸Œæœ›ä¸åŒçš„ HTTP è¯·æ±‚ç»‘å®šåŒæ ·çš„æ•°æ®åˆ°å¤šä¸ª UI æ§ä»¶ä¸Šå»

å‡è®¾ä½ æœ‰ä¸‹é¢çš„å®ç°ï¼š

```swift
let searchResults = searchText
    .throttle(.milliseconds(300), scheduler: MainScheduler.instance)
    .distinctUntilChanged()
    .flatMapLatest { query in
        API.getSearchResults(query)
            .retry(3)
            .startWith([]) // clears results on new search term
            .catchErrorJustReturn([])
    }
    .share(replay: 1)    // <- notice the `share` operator
```

é€šå¸¸ä½ æƒ³è¦çš„æ˜¯è®¡ç®—ä¹‹åå…±äº«æœç´¢çš„ç»“æœï¼Œè¿™å°±æ˜¯ `share` çš„æ„ä¹‰

**UI å±‚ä¸­ï¼Œåœ¨å˜æ¢é“¾çš„æœ€åæ·»åŠ  `shard` é€šå¸¸æ˜¯ä¸€ä¸ªå¥½çš„è§„åˆ™ï¼Œå› ä¸ºä½ æœ€æƒ³å…±äº«è®¡ç®—çš„ç»“æœã€‚ä½ ä¸æƒ³åœ¨ç»‘å®š `searchResults` åˆ°å¤šä¸ª UI æ§ä»¶çš„æ—¶å€™è§¦å‘ä¸åŒçš„ HTTP è¿æ¥**

**ä¹Ÿçœ‹ä¸€ä¸‹ `Driver` å•å…ƒã€‚å®ƒæ˜¯è¢«è®¾è®¡ç”¨æ¥é€æ˜åœ°å°è£…è¿™äº› `share` è°ƒç”¨çš„ï¼Œç¡®ä¿å…ƒç´ åœ¨ä¸»çº¿ç¨‹è¢«è§‚å¯Ÿå¹¶ä¸”æ²¡æœ‰é”™è¯¯ç»‘å®šåˆ° UI ä¸Š**

## Making HTTP requests

åˆ¶ä½œ HTTP è¯·æ±‚æ˜¯äººä»¬å°è¯•çš„ç¬¬ä¸€ä»¶äº‹

é¦–å…ˆä½ è¦åˆ›å»º `URLRequest` å¯¹è±¡æ¥è¡¨ç¤ºéœ€è¦è¢«å®Œæˆçš„å·¥ä½œï¼ŒRequest ç¡®å®šè¯·æ±‚ç±»å‹(GET, POSTâ€¦)ï¼Œæ˜¯å¦æœ‰è¯·æ±‚ä½“ï¼Œè¯·æ±‚å‚æ•°ç­‰

ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ GET è¯·æ±‚çš„ä¾‹å­

```swift
let req = URLRequest(url: URL(string: "http://en.wikipedia.org/w/api.php?action=parse&page=Pizza&format=json"))
```

å¦‚æœä½ æƒ³è¦ä»…æ‰§è¡Œäº†è¿™ä¸ªè¯·æ±‚è€Œä¸æ˜¯å’Œå…¶å®ƒçš„ `observable` ç»„åˆï¼Œä¸‹é¢çš„ä»£ç å°±å¯ä»¥å®ç°

```swift
let responseJSON = URLSession.shared.rx.json(request: req)

// no requests will be performed up to this point
// `responseJSON` is just a description how to fetch the response


let cancelRequest = responseJSON
    // this will fire the request
    .subscribe(onNext: { json in
        print(json)
    })

Thread.sleep(forTimeInterval: 3.0)

// if you want to cancel request after 3 seconds have passed just call
cancelRequest.dispose()
```

**URLSession extensions é»˜è®¤ä¸ä¼šåœ¨ `MainScheduler`  è¿”å›ç»“æœ**

å¦‚æœä½ æƒ³è¦æ›´åº•å±‚çš„ responseï¼Œä½ å¯ä»¥ï¼š

```swift
URLSession.shared.rx.response(myURLRequest)
    .debug("my request") // this will print out information to console
    .flatMap { (data: NSData, response: URLResponse) -> Observable<String> in
        if let response = response as? HTTPURLResponse {
            if 200 ..< 300 ~= response.statusCode {
                return just(transform(data))
            }
            else {
                return Observable.error(yourNSError)
            }
        }
        else {
            rxFatalError("response = nil")
            return Observable.error(yourNSError)
        }
    }
    .subscribe { event in
        print(event) // if error happened, this will also print out error to console
    }
```
### Logging HTTP traffic

åœ¨ debug æ¨¡å¼ä¸‹ï¼ŒRxCocoa é»˜è®¤ä¼šè®°å½•æ‰€æœ‰çš„ HTTP è¯·æ±‚åˆ°æ§åˆ¶å°ä¸­ï¼Œå¦‚æœä½ æƒ³æ”¹å˜è¿™ä¸ªè¡¨ç°ï¼Œå¯ä»¥è®¾ç½® `Logging.URLRequests` è¿‡æ»¤å™¨

```swift
// read your own configuration
public struct Logging {
    public typealias LogURLRequest = (URLRequest) -> Bool

    public static var URLRequests: LogURLRequest =  { _ in
    #if DEBUG
        return true
    #else
        return false
    #endif
    }
}
```

## RxDataSources

æ˜¯ä¸€ä¸ªå®ç°äº† `UITableView`s å’Œ `UICollectionView` å…¨åŠŸèƒ½äº¤äº’æ•°æ®æºçš„ç±»é›†åˆ

RxDataSources  æ‰“åŒ…åœ¨[è¿™é‡Œ](https://github.com/RxSwiftCommunity/RxDataSources).

å¦‚ä½•ä½¿ç”¨å®ƒä»¬çš„å…¨åŠŸèƒ½ç¤ºèŒƒåœ¨ [RxExample](../RxExample) é¡¹ç›®

## å‚è€ƒ

1. <https://medium.com/gett-engineering/rxswift-share-ing-is-caring-341557714a2d>