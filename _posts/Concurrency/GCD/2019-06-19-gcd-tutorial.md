---
title: GCD å…¥é—¨
excerpt: å¹¶è¡Œå¹¶å‘ã€åŒæ­¥å¼‚æ­¥ã€é˜Ÿåˆ—ã€å¤šè¯»å•å†™ã€ç»„
tags:
  - GCD
toc: true
---

## Concurrency

iOS ä¸­ä¸€ä¸ªåº”ç”¨è¿›ç¨‹å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ã€‚æ“ä½œç³»ç»Ÿç®¡ç†æ¯ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½**å¯ä»¥**å¹¶å‘åœ°æ‰§è¡Œï¼Œä½†æ˜¯æ“ä½œç³»ç»Ÿå†³å®šæ˜¯å¦ä¼šåŒæ—¶æ‰§è¡Œï¼Œä»€ä¹ˆæ—¶å€™ï¼Œä»¥åŠå¦‚ä½•å®ç°ã€‚

å•æ ¸å¤„ç†å™¨è®¾å¤‡é€šè¿‡ **time-slicing(æ—¶é—´ç‰‡)** å®ç°ï¼Œæ‰§è¡Œä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰§è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå†æ‰§è¡Œå¦ä¸€ä¸ªçº¿ç¨‹ã€‚

å¤šæ ¸å¤„ç†å™¨è®¾å¤‡ï¼Œé€šè¿‡ **parallelism(å¹¶è¡Œ)** åŒæ—¶æ‰§è¡Œå¤šä¸ªçº¿ç¨‹ã€‚

<img width="50%" height="50%" src="/assets/images/Concurrency_vs_Parallelism.png"/>

GCD å»ºç«‹åœ¨çº¿ç¨‹ä¹‹ä¸Šï¼Œå®ƒç»´æŠ¤ç€ä¸€ä¸ªçº¿ç¨‹æ± ã€‚åœ¨ GCD ä¸­é€šè¿‡ä»£ç å—æ·»åŠ ä»»åŠ¡åˆ° **dispatch queues** ç„¶å GCD å†³å®šç”¨å“ªä¸ªçº¿ç¨‹å»æ‰§è¡Œå®ƒä»¬ã€‚

GCD æ ¹æ®ç³»ç»Ÿå’Œå¯ç”¨çš„ç³»ç»Ÿèµ„æºæ¥å†³å®šæœ‰å¤šå°‘ä¸ªå¹¶è¡Œã€‚

> å¹¶è¡Œéœ€è¦å¹¶å‘ï¼Œä½†æ˜¯å¹¶å‘å¹¶ä¸ä¿è¯å¹¶è¡Œ

**å¹¶å‘å¹¶è¡Œçš„åŒºåˆ«**

>concurrency is about *structure* while parallelism is about *execution*

## Queues

GCD ä»¥ FIFO çš„é¡ºåºæ‰§è¡Œæ·»åŠ è¿›é˜Ÿåˆ—çš„ä»»åŠ¡ï¼Œä¿è¯å…ˆæ·»åŠ è¿›é˜Ÿåˆ—çš„ä»»åŠ¡æ¯”åæ·»åŠ è¿›é˜Ÿåˆ—çš„ä»»åŠ¡å…ˆ**å¼€å§‹**æ‰§è¡Œã€‚

Dispatch queues æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¯ä»¥å¤šçº¿ç¨‹åŒæ—¶å­˜å–é˜Ÿåˆ—ã€‚

é˜Ÿåˆ—åˆ†ä¸º**ä¸²è¡Œ**é˜Ÿåˆ—å’Œ**å¹¶å‘**é˜Ÿåˆ—ã€‚

ä¸²è¡Œé˜Ÿåˆ—ä¿è¯åœ¨æŸä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªä»»åŠ¡åœ¨æ‰§è¡Œï¼ŒGCD æ§åˆ¶æ‰§è¡Œæ—¶é—´ï¼Œä½ ä¸èƒ½ç¡®å®šåœ¨ä»»åŠ¡ä¹‹é—´çš„é—´éš”æ—¶é—´ã€‚

<img width="50%" height="50%" src="/assets/images/Serial-Queue-Swift.png"/>

å¹¶å‘é˜Ÿåˆ—å¯ä»¥è®©å¤šä¸ªä»»åŠ¡åœ¨åŒä¸€æ—¶é—´æ‰§è¡Œã€‚ä»»åŠ¡å¼€å§‹æ‰§è¡Œçš„é¡ºåºè¿˜æ˜¯éµå®ˆ FIFO çš„è§„åˆ™ï¼Œä»»åŠ¡ç»“æŸçš„é¡ºåºæ˜¯ä¸ç¡®å®šçš„ï¼Œå¼€å§‹ä¸¤ä¸ªä»»åŠ¡çš„æ—¶é—´é—´éš”ä¹Ÿæ˜¯ä¸ç¡®å®šçš„ï¼ŒåŒæ—¶æ‰§è¡Œçš„ä»»åŠ¡æ•°é‡ä¹Ÿæ˜¯ä¸ç¡®å®šçš„ã€‚

<img width="50%" height="50%" src="/assets/images/Concurrent-Queue-Swift.png"/>

å½“ä¸¤ä¸ªä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´é‡å æ—¶ï¼ŒGCD ä¼šå†³å®šæ˜¯å¦åœ¨å¤šæ ¸ä¸Šæ‰§è¡Œæˆ–è€…é€šè¿‡æ—¶é—´ç‰‡çš„æ–¹å¼æ‰§è¡Œã€‚

GCD æä¾›ä¸‰ç§ä¸»è¦ç±»å‹çš„é˜Ÿåˆ—ï¼š

1. **Main queue**ï¼šåœ¨ä¸»çº¿ç¨‹æ‰§è¡Œå¹¶ä¸”æ˜¯ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—
2. **Global queues**: æ•´ä¸ªç³»ç»Ÿå…±äº«çš„å¹¶å‘é˜Ÿåˆ—ï¼Œå…±æœ‰å››ä¸ªä¸åŒä¼˜å…ˆçº§çš„é˜Ÿåˆ—ï¼š`high, default, low, background` ã€‚background ä¼˜å…ˆçº§çš„ queue åœ¨ I/O æ´»åŠ¨ä¸­è¢«é™åˆ¶ä»¥å‡å°‘å¯¹ç³»ç»Ÿçš„è´Ÿé¢å½±å“ã€‚
3. **Custom queues**: å¯ä»¥æ˜¯ä¸²è¡Œæˆ–è€…å¹¶å‘é˜Ÿåˆ—ï¼Œ*è¿™äº›é˜Ÿåˆ—ä¸­çš„è¯·æ±‚æœ€ç»ˆä¼šåœ¨ä¸€ä¸ªå…¨å±€é˜Ÿåˆ—ä¸­*

å…¨å±€é˜Ÿåˆ—çš„ä¼˜å…ˆçº§å±æ€§åœ¨ iOS8 ä¸Šè¢«åºŸå¼ƒï¼Œæ›¿ä»£çš„æ–¹å¼æ˜¯ä½¿ç”¨ QoSã€‚

1. **User-interactive**: ä»»åŠ¡å¿…é¡»é©¬ä¸Šå®Œæˆä»¥æä¾›ä¸€ä¸ªå¥½çš„ç”¨æˆ·ä½“éªŒã€‚
2. **User-initiated**: ç”¨æˆ·ä»UIæ“ä½œå¼€å§‹è¿™äº›å¼‚æ­¥æ“ä½œã€‚ç”¨äºç”¨æˆ·ç­‰å¾…ç«‹å³çš„ç»“æœå’Œè¢«ç”¨æˆ·äº¤äº’ä¾èµ–çš„ä»»åŠ¡ã€‚å¯¹åº” `high` ä¼˜å…ˆçº§å…¨å±€é˜Ÿåˆ—ã€‚
3. **Default**: é»˜è®¤ï¼ŒQoS å‚æ•°çœç•¥æ—¶çš„é»˜è®¤å€¼ï¼Œå¯¹åº” `default` ä¼˜å…ˆçº§å…¨å±€é˜Ÿåˆ—ã€‚
4. **Utility**: é•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡ï¼Œå…¸å‹çš„åº”ç”¨æ˜¯ç”¨æˆ·å¯è§çš„è¿›åº¦æŒ‡ç¤ºå™¨ã€‚å¯ç”¨äºè®¡ç®—ã€I/Oã€ç½‘ç»œã€æŒç»­æ•°æ®æµç­‰ã€‚å¯¹åº” `low` ä¼˜å…ˆçº§å…¨å±€é˜Ÿåˆ—ã€‚
5. **Background**: ç”¨æˆ·æ²¡æœ‰æ„è¯†åˆ°çš„ä»»åŠ¡ã€‚å¯ç”¨äºé¢„åŠ è½½ã€ç»´æŠ¤ã€å…¶å®ƒçš„æ— ç”¨æˆ·äº¤äº’çš„/éæ˜¯æ—¶é—´æ•æ„Ÿçš„ä»»åŠ¡ã€‚å¯¹åº” `background` ä¼˜å…ˆçº§çš„å…¨å±€é˜Ÿåˆ—ã€‚

## Synchronous vs. Asynchronous

åŒæ­¥æ–¹æ³•åœ¨ä»»åŠ¡å®Œæˆä¹‹åå°†æ§åˆ¶è¿”å›ç»™è°ƒç”¨è€…ã€‚

å¼‚æ­¥æ–¹æ³•ç«‹åˆ»è¿”å›ï¼Œä¿æŒä»»åŠ¡å¼€å§‹çš„é¡ºåºï¼Œä½†æ˜¯ä¸ä¼šç­‰å¾…ä»»åŠ¡çš„ç»“æŸã€‚å› æ­¤ï¼Œå¼‚æ­¥æ–¹æ³•ä¸ä¼šé˜»å¡å½“å‰çš„çº¿ç¨‹æ‰§è¡Œä¸‹ä¸€ä¸ªæ–¹æ³•ã€‚

**ä»€ä¹ˆæ—¶å€™ç”¨ async**

1. **Main Queue**: å­çº¿ç¨‹ç»“æŸä»»åŠ¡åæ›´æ–°UIå¯ä»¥é€šè¿‡ä¸»é˜Ÿåˆ—å’Œ async ä¿è¯æ›´æ–°UIçš„æ“ä½œä¼šåœ¨å½“å‰æ–¹æ³•æ‰§è¡Œå®Œæˆä¹‹åçš„æŸä¸ªæ—¶åˆ»æ‰§è¡Œ
2. **Global Queue**: æ™®é€šéUIæ“ä½œ
3. **Custom Serial Queue**: è¿ç»­çš„åå°ä»»åŠ¡ã€‚ä¸²è¡Œé˜Ÿåˆ—ä¸€ä¸ªæ—¶åˆ»åªæœ‰ä¸€ä¸ªä»»åŠ¡åœ¨æ‰§è¡Œï¼Œè§£å†³äº†èµ„æºç«äº‰é—®é¢˜ã€‚

**ä»€ä¹ˆæ—¶å€™ç”¨ sync**

1. **Main Queue**: æ³¨æ„æ­»é”çš„æƒ…å†µ
2. **Global Queue**: å¯ç”¨åœ¨ dispatch barrier ä¸­åŒæ­¥ä»»åŠ¡ï¼Œæˆ–è€…ç­‰å¾…ä¸€ä¸ªä»»åŠ¡å®Œæˆä¹‹åå†è¿›è¡Œå…¶å®ƒçš„æ“ä½œ
3. **Custom Serial Queue**: æ³¨æ„æ­»é”

## Managing Tasks

GCD ç”¨é—­åŒ…çš„æ–¹å¼æ·»åŠ ä»»åŠ¡ï¼Œæ¯ä¸ªæäº¤ç»™ `DispatchQueue` çš„ä»»åŠ¡éƒ½æ˜¯ä¸€ä¸ª `DispatchWorkItem` ã€‚

å¯ä»¥è®¾ç½®  `DispatchWorkItem` çš„ `QoS` æˆ–è€…æ˜¯å¦äº§ç”Ÿæ–°çš„çº¿ç¨‹ç­‰ã€‚

## Delaying Task Execution

ç”¨äºå¸Œæœ›ä»»åŠ¡åœ¨ç‰¹å®šæ—¶é—´è¿è¡Œçš„æ—¶å€™ã€‚

> å¯ä»¥ç”¨åœ¨ç»™æ–°å¯åŠ¨appçš„ç”¨æˆ·ä¸€äº›æç¤ºï¼Œå¦‚æœæç¤ºå¤ªæ—©å¯èƒ½ç”¨æˆ·å…³æ³¨ç‚¹åœ¨å…¶å®ƒåœ°æ–¹è€Œå¿½ç•¥äº†è¿™ä¸ªæç¤ºï¼Œæ‰€ä»¥å¯ä»¥ç”¨å»¶æ—¶ä»»åŠ¡å®Œæˆ

```swift
// 1
let delayInSeconds = 2.0

// 2
DispatchQueue.main.asyncAfter(deadline: .now() + delayInSeconds) { [weak self] in
  guard let self = self else {
    return
  }

  if PhotoManager.shared.photos.count > 0 {
    self.navigationItem.prompt = nil
  } else {
    self.navigationItem.prompt = "Add photos with faces to Googlyify them!"
  }

  // 3
  self.navigationController?.viewIfLoaded?.setNeedsLayout()
}
```

**ä¸ºä»€ä¹ˆä¸ç”¨ Timer**

1. å¯è¯»æ€§ï¼ŒTimer éœ€è¦å®šä¹‰ä¸€ä¸ªæ–¹æ³•ï¼Œç„¶åä½¿ç”¨å®šä¹‰çš„æ–¹æ³•ä¸º selector åˆ›å»ºä¸€ä¸ª Timerã€‚GCD æ–¹æ³•åªéœ€è¦é—­åŒ…
2. Timer ä¾èµ–äº runloopï¼Œæ‰€ä»¥ä½¿ç”¨ Timer éœ€è¦ä¿è¯å®ƒè¢«æ·»åŠ è¿›æ­£ç¡®çš„ runloop modeã€‚
3. Timer æ›´é€‚åˆç”¨åœ¨éœ€è¦é‡å¤çš„ä»»åŠ¡

## Handling the Readers-Writers Problem

å¯ä»¥é€šè¿‡ dispatch barriers è§£å†³[Readers-Writers Problem](http://en.wikipedia.org/wiki/Readersâ€“writers_problem)

å½“æäº¤ `DispatchWorkItem` åˆ°é˜Ÿåˆ—çš„æ—¶å€™ï¼Œå¯ä»¥è®¾ç½®ä¸€ä¸ªæ ‡è¯†æ¥è¡¨ç¤ºè¿™ä¸ªä»»åŠ¡åœ¨æ‰§è¡Œçš„æ—¶å€™æ‰€åœ¨é˜Ÿåˆ—åªæœ‰è¿™ä¸ªä»»åŠ¡åœ¨æ‰§è¡Œã€‚

1. æ‰€æœ‰ dispatch barrier ä¹‹å‰çš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæˆä¹‹åè¿™ä¸ª `DispatchWorkItem` æ‰ä¼šæ‰§è¡Œ
2. å½“è¿™ä¸ª`DispatchWorkItem` æ‰§è¡Œçš„æ—¶å€™ï¼Œæ‰€åœ¨é˜Ÿåˆ—åªæœ‰è¿™ä¸ªä»»åŠ¡åœ¨æ‰§è¡Œ
3. `DispatchWorkItem` æ‰§è¡Œå®Œæˆä¹‹åï¼Œæ‰€åœ¨é˜Ÿåˆ—å›åˆ°é»˜è®¤çš„è¡¨ç°

<img width="50%" height="50%" src="/assets/images/Dispatch-Barrier-Swift.png"/>

> å…¨å±€é˜Ÿåˆ—ä¸ºå…±äº«ï¼Œåœ¨å…¨å±€é˜Ÿåˆ—ä¸­ä½¿ç”¨ barrier éœ€è¦æ³¨æ„
>
> åœ¨è‡ªå®šä¹‰çš„å¹¶å‘é˜Ÿåˆ—ä¸­ä½¿ç”¨ barrier å®ç°çº¿ç¨‹å®‰å…¨æ˜¯æ¯”è¾ƒå¥½çš„å®è·µ

barrier è§£å†³äº†å†™çš„é—®é¢˜ï¼Œåœ¨åŒä¸€ä¸ªé˜Ÿåˆ—è¿›è¡Œè¯»æ“ä½œï¼Œä½†æ˜¯ä½¿ç”¨ `sync` æ–¹æ³•æ¥ä¿è¯æ–¹æ³•è¿”å›è¯»åˆ°æ•°æ®ã€‚

> å½“éœ€è¦**ç­‰å¾…**ä»»åŠ¡ç»“æŸä¹‹åå†ä½¿ç”¨ä»»åŠ¡é—­åŒ…å¤„ç†çš„æ•°æ®æ—¶ï¼Œä½¿ç”¨  sync

> **æ­»é” deadlock**
>
> å¦‚æœåœ¨æ‰§è¡Œçš„é˜Ÿåˆ—ä¸Šè°ƒç”¨ sync ä¼šå¯¼è‡´æ­»é”
>
> sync ä¼šç­‰å¾…é—­åŒ…æ‰§è¡Œå®Œæˆï¼Œä½†æ˜¯é—­åŒ…åœ¨å½“å‰æ‰§è¡Œçš„é—­åŒ…è°ƒç”¨å®Œæˆä¹‹å‰ä¸ä¼šè°ƒç”¨å®Œæˆæˆ–è€…è°ƒç”¨ï¼Œä½†æ˜¯å½“å‰æ‰§è¡Œçš„é—­åŒ…åˆåœ¨ç­‰å¾… sync çš„é—­åŒ…è°ƒç”¨ç»“æŸã€‚

## Dispatch Groups

dispatch group å¯ä»¥å°†å¤šä¸ªä»»åŠ¡ç»„åˆåœ¨ä¸€èµ·ï¼Œç„¶å**ç­‰å¾…**æ‰€æœ‰çš„ä»»åŠ¡å®Œæˆæˆ–è€…åœ¨æ‰€æœ‰çš„ä»»åŠ¡å®Œæˆä¹‹åå¾—åˆ°**é€šçŸ¥**ã€‚

ä¸€ä¸ªç»„ä¸­çš„ä»»åŠ¡å¯ä»¥æ˜¯åŒæ­¥çš„æˆ–è€…å¼‚æ­¥çš„ï¼Œå¹¶ä¸”å¯ä»¥è¿è¡Œåœ¨ä¸åŒçš„é˜Ÿåˆ—ä¸­ã€‚

`DispatchGroup` æ¥ç®¡ç† dispatch groupsã€‚

### **wait** 

è¿™ä¸ªæ–¹æ³•ä¼šé˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°æ‰€æœ‰å…¥é˜Ÿåˆ°ç»„ä¸­çš„ä»»åŠ¡éƒ½å®Œæˆ

1. ç”±äºä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œæ‰€æœ‰åº”è¯¥ä½¿ç”¨ GCD çš„ `async` æ–¹æ³•å’Œåå°é˜Ÿåˆ—æ¥ä¿è¯ä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹
2. åˆ›å»ºä¸€ä¸ªç»„
3. åœ¨æ¯ä¸ªä»»åŠ¡å¼€å§‹å‰è°ƒç”¨ç»„çš„ `enter` æ–¹æ³•ï¼Œåœ¨æ¯ä¸ªä»»åŠ¡ç»“æŸçš„æ—¶å€™è°ƒç”¨ç»„çš„ `leave` æ–¹æ³•ï¼Œä¸¤ä¸ªæ–¹æ³•è°ƒç”¨å¿…é¡»åŒ¹é…
4. è°ƒç”¨ç»„çš„ `wait` æ–¹æ³•æ¥é˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°æ‰€æœ‰çš„ä»»åŠ¡éƒ½å®Œæˆ(éƒ½è°ƒç”¨äº† `leave`)ã€‚æˆ–è€…è°ƒç”¨ `wait(timeout:)` æ¥æŒ‡å®šè¶…æ—¶æ—¶é—´ã€‚
5. `wait` ä¹‹åçš„è°ƒç”¨æ˜¯æ‰€æœ‰çš„ä»»åŠ¡éƒ½ç»“æŸäº†æˆ–è€…è¶…æ—¶äº†ï¼Œå¯ä»¥å¤„ç†ä»»åŠ¡ä¹‹åçš„æ•°æ®ã€‚

### **notify**

ä½¿ç”¨è¿™ä¸ªæ–¹æ³•å¯ä»¥åœ¨åœ¨æ‰€æœ‰ç»„ä¸­çš„ä»»åŠ¡å®Œæˆä¹‹åå¾—åˆ°é€šçŸ¥ï¼Œå¹¶ä¸”ä¸ä¼šåƒ `wait` æ–¹æ³•ä¸€æ ·é˜»å¡å½“å‰çº¿ç¨‹ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ `notify` æ–¹æ³•ä¸­æŒ‡å®šæ¥æ”¶é€šçŸ¥çš„é˜Ÿåˆ—ã€‚

1. åˆ›å»ºä¸€ä¸ª `DispatchGroup`
2. åœ¨ä»»åŠ¡å¼€å§‹å‰è°ƒç”¨ç»„çš„ `enter` æ–¹æ³•ï¼Œåœ¨ä»»åŠ¡ç»“æŸä¹‹åè°ƒç”¨ç»„çš„ `leave` æ–¹æ³•ï¼ŒåŒæ ·ä¸¤ä¸ªæ–¹æ³•çš„è°ƒç”¨éœ€è¦åŒ¹é…
3. è°ƒç”¨ç»„çš„ `notify(queue:work:)` æ–¹æ³•æŒ‡å®šæ¥æ”¶é€šçŸ¥çš„é˜Ÿåˆ—å’Œåç»­çš„å¤„ç†

## Concurrency Looping

`DispatchQueue.concurrentPerform(iterations:execute:)` å¯ä»¥å¹¶å‘åœ°æ‰§è¡Œéå†ï¼Œå®ƒæ˜¯åŒæ­¥çš„ï¼Œä¼šåœ¨æ‰€æœ‰çš„éå†ä»»åŠ¡å®Œæˆåé€€å‡º

> éœ€è¦æ³¨æ„éå†è¿­ä»£çš„æ¬¡æ•°å’Œæ¯æ¬¡è¿­ä»£çš„å·¥ä½œé‡ï¼Œå¦‚æœè¿­ä»£æ¬¡æ•°å¾ˆå¤šå¹¶ä¸”æ¯æ¬¡è¿­ä»£çš„å·¥ä½œé‡å¾ˆå°ä¼šé€ æˆå¾ˆå¤šå¼€é”€ä»¥è‡³äºæŠµæ¶ˆå¹¶å‘è¿­ä»£çš„æ”¶ç›Šã€‚**striding** çš„æŠ€æœ¯å¯ä»¥å¸®åŠ©æˆ‘ä»¬é¿å…è¿™ç§æƒ…å†µï¼Œstriding å¯ä»¥è®©æˆ‘ä»¬åœ¨ä¸€æ¬¡è¿­ä»£ä¸­åšå¤šä¸ªéƒ¨åˆ†çš„ä»»åŠ¡

**ä»€ä¹ˆæ—¶å€™ä½¿ç”¨**

1. å¯ä»¥æ’é™¤ä¸²è¡Œé˜Ÿåˆ—ï¼Œå› ä¸ºæ ¹æœ¬æ²¡æœ‰ç›Šå¤„
2. åœ¨åŒ…å«å¾ªç¯çš„å¹¶å‘é˜Ÿåˆ—ä¸­ä½¿ç”¨æ˜¯ä¸€ç§å¥½çš„é€‰æ‹©ï¼Œå°¤å…¶æ˜¯å½“ä½ éœ€è¦è¿½è¸ªè¿›åº¦çš„æ—¶å€™

```swift
// ä»…ä¸ºç¤ºä¾‹ï¼Œä¸‹é¢çš„æƒ…å†µå¹¶ä¸åˆé€‚ç”¨å¹¶å‘éå†

var storedError: NSError?
let downloadGroup = DispatchGroup()
let addresses = [PhotoURLString.overlyAttachedGirlfriend,
                 PhotoURLString.successKid,
                 PhotoURLString.lotsOfFaces]
// å‘Šè¯‰GCDä½¿ç”¨QoSä¸º .userInitiatedçš„é˜Ÿåˆ—æ¥å®ç°å¹¶å‘è°ƒç”¨
let _ = DispatchQueue.global(qos: .userInitiated)
DispatchQueue.concurrentPerform(iterations: addresses.count) { index in
  let address = addresses[index]
  let url = URL(string: address)
  downloadGroup.enter()
  let photo = DownloadPhoto(url: url!) { _, error in
    if error != nil {
      storedError = error
    }
    downloadGroup.leave()
  }
  PhotoManager.shared.addPhoto(photo)
}
downloadGroup.notify(queue: DispatchQueue.main) {
  completion?(storedError)
}
```

## Canceling Dispatch Blocks

GCD çš„ä»»åŠ¡ä»¥é—­åŒ…çš„å½¢å¼æ´¾å‘ï¼Œå®é™…æ˜¯ä¸€ä¸ª `DispatchWorkItem`ï¼Œå–æ¶ˆå°±æ˜¯ç”¨åˆ°äº† `DispatchWorkItem` æ¥å‘æŒ¥ä½œç”¨

>  **å–æ¶ˆå¿…é¡»åœ¨ä»»åŠ¡åˆ°è¾¾é˜Ÿåˆ—çš„å¤´å¼€å§‹æ‰§è¡Œä¹‹å‰**ã€‚

1. ä½¿ç”¨ `DispatchWorkItem(qos:flags:block:)` åˆ›å»ºä¸€ä¸ªå¯¹è±¡ï¼Œ`flags` å¯ä»¥æŒ‡å®š `.inheritQoS` æ¥ä½¿ç”¨æ´¾å‘åˆ°çš„é˜Ÿåˆ—çš„ QoS
2. æ´¾å‘æ‰€æœ‰åˆ›å»ºçš„ `DispatchWorkItem` åˆ°ä¸€ä¸ªé˜Ÿåˆ—æ‰§è¡Œï¼Œå¯åˆ©ç”¨ä¸²è¡Œé˜Ÿåˆ—çš„ç‰¹æ€§ä¿è¯åç»­çš„å–æ¶ˆæ“ä½œçš„åœ¨ä»»åŠ¡å¼€å§‹ä¹‹å‰æ‰§è¡Œ
3. è°ƒç”¨ `DispatchWorkItem` çš„ `cancel` æ–¹æ³•æ¥å–æ¶ˆä»»åŠ¡çš„æ‰§è¡Œï¼Œå¹¶è°ƒç”¨ç»„çš„ `leave` æ–¹æ³•

é…åˆ[ä»£ç ](https://github.com/hotchner/Demos/blob/master/GooglyPuff/GooglyPuff/PhotoManager.swift)äº«ç”¨ï¼Œæ›´å¤šå‚è€ƒ [Apple's documentation](https://developer.apple.com/documentation/dispatch/dispatchworkitem)

## Miscellaneous GCD Fun

### Semaphores

ä¿¡å·é‡é—®é¢˜è®¨è®ºå‚è€ƒ [detailed discussion](https://greenteapress.com/wp/semaphores/) å’Œ  [Dining Philosophers Problem](http://en.wikipedia.org/wiki/Dining_philosophers_problem)

1. åˆ›å»ºä¸€ä¸ªä¿¡å·é‡å¹¶æŒ‡å®šåˆå§‹å€¼ï¼Œè¿™ä¸ªå€¼ä»£è¡¨å¯ä»¥åŒæ—¶è®¿é—®çš„æ•°é‡
2. å½“ä¸€ä¸ªè®¿é—®ç»“æŸçš„æ—¶å€™ï¼Œè°ƒç”¨ä¿¡å·é‡çš„ `signal` æ–¹æ³•å¢åŠ ä¿¡å·é‡çš„å€¼
3. è°ƒç”¨ä¿¡å·é‡çš„ `wait` æ–¹æ³•é˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°ä¿¡å·é‡çš„å€¼å¤§äº0å³èµ„æºå¯è®¿é—®ï¼Œ`wait` æ–¹æ³•è¿˜å¯ä»¥æŒ‡å®šè¶…æ—¶æ—¶é—´ã€‚ä¿¡å·é‡çš„è¿”å›å€¼æ˜¯æšä¸¾ï¼Œ`success` æˆ–è€… `timeout`

### Dispatch Sources

dispatch sources å¯ä»¥ç”¨æ¥ç›‘å¬ä¸€äº›äº‹ä»¶ï¼ŒåŒ…æ‹¬ Unix signalsã€file descriptorsã€Mach portsã€VFS Nodesç­‰

**è®¾ç½® dispatch source**

1. è®¾ç½®è¦ç›‘å¬çš„äº‹ä»¶ç±»å‹ã€æ¥æ”¶äº‹ä»¶å›è°ƒçš„ dispatch queue
2. å°†äº‹ä»¶ handler èµ‹å€¼ç»™ dispatch source
3. å‰ä¸¤æ­¥å®Œæˆå dispatch source å¤„äº suspended çŠ¶æ€ï¼Œä»è€Œå…è®¸æˆ‘ä»¬è¿›è¡Œè¿›ä¸€æ­¥çš„è®¾ç½®ï¼Œæ¯”å¦‚è®¾ç½® event handlerã€‚è®¾ç½®å®Œæˆåï¼Œè°ƒç”¨ source çš„ `resume` æ–¹æ³•å¼€å§‹äº‹ä»¶å¤„ç†

**ä¸€ä¸ªğŸŒ°**

```swift
// 1
#if DEBUG

  // 2
  var signal: DispatchSourceSignal?

  // 3
  private let setupSignalHandlerFor = { (_ object: AnyObject) in
    let queue = DispatchQueue.main

    // 4
    signal =
      DispatchSource.makeSignalSource(signal: SIGSTOP, queue: queue)
        
    // 5
    signal?.setEventHandler {
      print("Hi, I am: \(object.description!)")
    }

    // 6
    signal?.resume()
  }
#endif

// åœ¨viewDidLoadä¸­è°ƒç”¨
#if DEBUG
  setupSignalHandlerFor(self)
#endif
```

DEBUG æ¨¡å¼ä¸­ï¼Œç‚¹å‡» Xcode debug æ ä¸­çš„ pause å’Œ continue å¯ä»¥çœ‹åˆ°è¾“å‡ºä¿¡æ¯

**åº”ç”¨åœºæ™¯çŒœæƒ³**

1. åš app é˜²æŠ¤ï¼Œé˜²æ­¢æ”»å‡»è€… attache debugger åˆ° app ä¸Š

2. åšå †æ ˆè¿½è¸ªå·¥å…·ï¼Œæ–¹ä¾¿æ‰¾åˆ°æƒ³åœ¨ debugger ä¸­æ“ä½œçš„å¯¹è±¡

3. è¾…åŠ©è°ƒè¯•ï¼Œè¿˜æ˜¯ä¸Šé¢çš„ğŸŒ°ï¼Œåœ¨ EventHandler çš„ print æ–¹æ³•ä¸Šå¢åŠ æ–­ç‚¹ï¼Œåˆ™å¯ä»¥åœ¨ app è¿è¡Œçš„ä»»æ„æ—¶åˆ»é€šè¿‡ pause å’Œ continue è¿›å…¥åˆ°æ­¤æ–­ç‚¹ï¼Œç„¶åè¿›è¡Œè¿›ä¸€æ­¥çš„è°ƒè¯•

   ```swift
   expression let $vc = unsafeBitCast(0x7fd301d0a310, to: GooglyPuff.PhotoCollectionViewController.self)
   expression $vc.navigationItem.prompt = "WOOT!"
   ```

## Reference

1. ä¸å®Œæ•´ç¿»è¯‘è‡ª raywenderlich çš„ grand-central-dispatch-tutorial-for-swift-4 [part-1](https://www.raywenderlich.com/5370-grand-central-dispatch-tutorial-for-swift-4-part-1-2)  [part-2](https://www.raywenderlich.com/5371-grand-central-dispatch-tutorial-for-swift-4-part-2-2)
2. [demo](https://github.com/hotchner/Demos/tree/master/GooglyPuff)
